#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#define N 10

typedef struct {
    char board[N][N];
    int visible[N][N];
} Game;

static int SHIPS[] = {5, 4, 3, 3, 2};
static const int NUM_SHIPS = (int)(sizeof(SHIPS)/sizeof(SHIPS[0]));

static int in_bounds(int r, int c){ return r>=0 && r<N && c>=0 && c<N; }

static void clear_input(void){
    int ch;
    while((ch=getchar())!='\n' && ch!=EOF){}
}

static int read_int(const char *prompt, int lo, int hi){
    int v;
    for(;;){
        printf("%s", prompt);
        if(scanf("%d", &v)==1 && v>=lo && v<=hi){ clear_input(); return v; }
        printf("Valor invalido. Tente %d..%d\n", lo, hi);
        clear_input();
    }
}

static void init_game(Game *g){
    for(int i=0;i<N;i++){
        for(int j=0;j<N;j++){
            g->board[i][j]='.';
            g->visible[i][j]=0;
        }
    }
}

static int place_ship(Game *g, int len){
    for(int tries=0; tries<300; tries++){
        int dir = rand()%2;
        int r = rand()%N, c=rand()%N;
        if(dir==0){
            if(c+len > N) continue;
            int ok=1;
            for(int j=0;j<len;j++) if(g->board[r][c+j] != '.') { ok=0; break; }
            if(!ok) continue;
            for(int j=0;j<len;j++) g->board[r][c+j]='S';
            return 1;
        }else{
            if(r+len > N) continue;
            int ok=1;
            for(int i=0;i<len;i++) if(g->board[r+i][c] != '.') { ok=0; break; }
            if(!ok) continue;
            for(int i=0;i<len;i++) g->board[r+i][c]='S';
            return 1;
        }
    }
    return 0;
}

static void random_fleet(Game *g){
    for(int k=0;k<NUM_SHIPS;k++){
        if(!place_ship(g, SHIPS[k])){
            init_game(g);
            k = -1;
        }
    }
}

static void print_player_view(const Game *g){
    printf("\n    ");
    for(int j=0;j<N;j++) printf("%2d", j);
    printf("\n   +");
    for(int j=0;j<N;j++) printf("--");
    printf("+\n");
    for(int i=0;i<N;i++){
        printf("%2d |", i);
        for(int j=0;j<N;j++){
            char ch = g->board[i][j];
            if(g->visible[i][j]){
                if(ch=='S')      printf(" S");
                else if(ch=='X') printf(" X");
                else if(ch=='o') printf(" o");
                else             printf(" .");
            }else{
                if(ch=='X' || ch=='o') printf(" %c", ch);
                else                    printf(" ?");
            }
        }
        printf(" |\n");
    }
    printf("   +");
    for(int j=0;j<N;j++) printf("--");
    printf("+\n");
}

static int shoot_cell(Game *g, int r, int c, int reveal){
    if(!in_bounds(r,c)) return 0;
    if(reveal) g->visible[r][c]=1;
    if(g->board[r][c]=='X' || g->board[r][c]=='o') return -1;
    if(g->board[r][c]=='S'){ g->board[r][c]='X'; return 1; }
    g->board[r][c]='o'; return 0;
}

static int remaining_ship_cells(const Game *g){
    int left=0;
    for(int i=0;i<N;i++)
        for(int j=0;j<N;j++)
            if(g->board[i][j]=='S') left++;
    return left;
}

static void ability_bomb(Game *g, int r, int c){
    for(int dr=-1; dr<=1; dr++){
        for(int dc=-1; dc<=1; dc++){
            int rr=r+dr, cc=c+dc;
            if(!in_bounds(rr,cc)) continue;
            g->visible[rr][cc]=1;
            shoot_cell(g, rr, cc, 0);
        }
    }
}

static void ability_row(Game *g, int row){
    for(int j=0;j<N;j++){
        g->visible[row][j]=1;
        shoot_cell(g, row, j, 0);
    }
}

static void ability_col(Game *g, int col){
    for(int i=0;i<N;i++){
        g->visible[i][col]=1;
        shoot_cell(g, i, col, 0);
    }
}

static void ability_radar(Game *g, int r, int c){
    for(int dr=-1; dr<=1; dr++){
        for(int dc=-1; dc<=1; dc++){
            int rr=r+dr, cc=c+dc;
            if(!in_bounds(rr,cc)) continue;
            g->visible[rr][cc]=1;
        }
    }
}

static void show_menu(void){
    printf("\n1) Disparo simples\n");
    printf("2) Bomba 3x3\n");
    printf("3) Ataque em linha\n");
    printf("4) Ataque em coluna\n");
    printf("5) Radar 3x3\n");
    printf("6) Mostrar tabuleiro\n");
    printf("0) Sair\n");
}

int main(void){
    Game g;
    init_game(&g);
    srand(42u);
    random_fleet(&g);
    printf("Batalha Naval (10x10)\n");
    while(1){
        if(remaining_ship_cells(&g)==0){
            printf("\nVitoria! Todos os navios foram destruidos.\n");
            print_player_view(&g);
            break;
        }
        show_menu();
        int op = read_int("Escolha: ", 0, 6);
        if(op==0) break;
        else if(op==1){
            int r = read_int("Linha: ", 0, 9);
            int c = read_int("Coluna: ", 0, 9);
            g.visible[r][c]=1;
            int res = shoot_cell(&g, r, c, 0);
            if(res==1) printf("Acerto!\n");
            else if(res==0) printf("Agua!\n");
            else printf("Ja tentou.\n");
        }else if(op==2){
            int r = read_int("Linha: ", 0, 9);
            int c = read_int("Coluna: ", 0, 9);
            ability_bomb(&g, r, c);
        }else if(op==3){
            int row = read_int("Linha: ", 0, 9);
            ability_row(&g, row);
        }else if(op==4){
            int col = read_int("Coluna: ", 0, 9);
            ability_col(&g, col);
        }else if(op==5){
            int r = read_int("Linha: ", 0, 9);
            int c = read_int("Coluna: ", 0, 9);
            ability_radar(&g, r, c);
        }else if(op==6){
            print_player_view(&g);
            printf("Restam %d celulas de navio.\n", remaining_ship_cells(&g));
        }
    }
    return 0;
}
